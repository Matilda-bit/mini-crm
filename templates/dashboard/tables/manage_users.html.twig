{# templates/dashboard/manage_users.html.twig #}

{% include 'components/flash_messages.html.twig' with {
    'error': 'users_tb_error',
    'success': 'users_tb_success'
} %}
<h2>
    {% if 'admin' in route %}
        Manage Users
    {% else %}
        Users / Agents
    {% endif %}
</h2>

{% if users is not empty %}

<div style="margin-bottom: 10px;">
    <select id="columnSelect" style="padding: 5px;">
        <option value="all">Search All Columns</option>
        <option value="0">ID</option>
        <option value="1">Username</option>
        <option value="3">Date Created</option>
        <option value="4">Agent ID</option>
    </select>

    <input type="text" id="customSearch" placeholder="Search..." style="padding: 5px;">
</div>

<table id="usersTable" class="display">
    <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Date Created</th>
            <th>Agent ID</th>
            <th>Assigned Agent</th>
        </tr>
    </thead>
    <tbody>
        {% for u in users %}
            <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.role }}</td>
                <td>{{ u.dateCreated|date('Y-m-d') }}</td>
                <td>
                    {% if u.agent %}
                        {{ u.agent.id }}
                    {% else %}
                        <span style="color: red;">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if 'admin' in route %}
                        <form method="POST" action="{{ path(route ~ '_assign_agent', {'userId': user.id}) }}">
                            <select name="agent_id" class="form-control">
                                {% for agent in agents %}
                                    <option value="{{ agent.id }}" {% if u.agent and agent.id == u.agent.id %}selected{% endif %}>
                                        {{ agent.username }} ({{ agent.id }})
                                    </option>
                                {% endfor %}
                            </select>
                            <input type="hidden" name="user_id" value="{{ u.id }}">
                            <button type="submit">Assign</button>
                        </form>
                    {% else %}
                        {% if u.agent %}
                            {{ u.agent.username }}
                        {% else %}
                            No Agent
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
    <p><em>No users found...</em></p>
{% endif %}


{# todo: move it to assets/js/table-search.js #}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function() {
        const table = $('#usersTable').DataTable({
            dom: 'lrtip', // убираем стандартный input
            searching: true
        });

        $('#customSearch').on('keyup', function() {
            const selectedColumn = $('#columnSelect').val();
            const value = this.value;

            if (selectedColumn === 'all') {
                table.search(value).draw(); // глобальный поиск
            } else {
                table.search('').columns().search(''); // сброс всех фильтров
                table.column(selectedColumn).search(value).draw(); // поиск по выбранной колонке
            }
        });

        $('#columnSelect').on('change', function() {
            $('#customSearch').trigger('keyup'); // сразу применить поиск при смене колонки
        });
    });
</script>